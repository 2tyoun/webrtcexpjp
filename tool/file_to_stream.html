<!doctype html>
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
 <title>Files to stream</title>
</head>
<body>
  <h4>Local Video/Audio files to stream</h4>
  <div id="file_to_stream_box">
    <div id="video_select_box" style="width:40%; display: inline-block;">
      select local video file: <input id="selected_video_file" type="file" onchange="setSelectedVideoFile()"></input>
      <div id="droped_video_file" style="height:50px; width:100%; border: 1px solid black; background-color: #EEEEEE; paddig:5px;　display: inline-block;">
        &nbsp; or Drag&Drop Video file here:<br />
        &nbsp;&nbsp; <span id="selected_video_filename"></span>
      </div>
      <video id="local_video" autoplay style="width: 160px; height: 120px; border: 1px solid black; margin-top:5px;"></video>&nbsp;&nbsp;
    </div>

    <div id="audio_select_box" style="width:40%;  display: inline-block; vertical-align: top;">
      select local audio file: <input id="selected_audio_file" type="file" onchange="setSelectedAudioFile()"></input>
      <div id="droped_audio_file" style="height:50px; width:100%; border: 1px solid black; background-color: #EEEEEE; paddig:5px; display: inline-block;">
        &nbsp; or Drag&Drop Audio file here:<br/>
        &nbsp;&nbsp; <span id="selected_audio_filename"></span>
      </div>
      <audio id="local_audio" autoplay controls="1" style="width: 240px; border: 1px solid black; margin-top:5px;"></audio>&nbsp;&nbsp;
    </div>

    <br />
    <button type="button" onclick="startVideo();">Start</button>
    <button type="button" onclick="stopVideo();">Stop</button>
    <br />
    <video id="monitor_video" autoplay style="width: 160px; height: 120px; border: 1px solid black;"></video>
    <br />
    <canvas id="duplicate_canvas" width="640px" height="480px" style="border: 1px solid black;"></canvas><br />
  </div>
</body>
<script type="text/javascript">
  let selectedVideoFile = document.getElementById('selected_video_file');
  let dropVideoDiv = document.getElementById('droped_video_file');
  let selectedVideoFilenameSpan = document.getElementById('selected_video_filename');
  dropVideoDiv.ondrop = onFileDrop;
  dropVideoDiv.ondragover = onFileDragOver;
  dropVideoDiv.ondragleave = onFileLeave;

  let selectedAudioFile = document.getElementById('selected_audio_file');
  let dropAudioDiv = document.getElementById('droped_audio_file');
  dropAudioDiv.ondrop = onFileDrop;
  dropAudioDiv.ondragover = onFileDragOver;
  dropAudioDiv.ondragleave = onFileLeave;
  //let videoURL = document.getElementById('video_url');
  let localAudio = document.getElementById('local_audio');
  let monitorAudio = document.getElementById('monitor_audio');
  let audioFileToPlay = null;


  let duplicateCanvas = document.getElementById('duplicate_canvas');
  let ctxDuplicate = duplicateCanvas.getContext('2d');
  let localVideo = document.getElementById('local_video');
  let monitorVideo = document.getElementById('monitor_video');
  let videoFileToPlay = null;
  let animationId = null;
  let duplicateStream = duplicateCanvas.captureStream(30);

  // --- audio -----
  let audioContext = new AudioContext();
  let audioSource = null;
  let audioOutputNode = null;
  let audioOutputSteram = null;



  // ---------------------- video handling ----------------------- 
  function setSelectedVideoFile() {
    if (selectedVideoFile.files.length == 0) {
      console.warn('file not selected');
      return;
    }

    videoFileToPlay = selectedVideoFile.files[0];
    console.log('selected file=' + videoFileToPlay.name);
    selectedVideoFilenameSpan.innerHTML = videoFileToPlay.name;
    startVideo();
  }

  function onFileDrop(evt) {
    //console.log('onFileDrop() evt:', evt);
    console.log(evt.dataTransfer.files);
    evt.stopPropagation();
    evt.preventDefault();
    dropVideoDiv.style.backgroundColor = '#EEEEEE'; 

    if (evt.dataTransfer.files.length > 0) {
      videoFileToPlay = evt.dataTransfer.files[0];
      console.log('dropped file=' + videoFileToPlay.name);
      selectedVideoFilenameSpan.innerHTML = videoFileToPlay.name;
      startVideo();
    }    
  }

  function onFileDragOver(evt) {
    //console.log('onFileDragOver() evt:', evt);
    evt.stopPropagation();
    evt.preventDefault();　// <-- must to avoid open file in browser

    dropVideoDiv.style.backgroundColor = '#F0E0E0'; 
  }

  function onFileLeave(evt) {
    //evt.stopPropagation();
    //evt.preventDefault();
    dropVideoDiv.style.backgroundColor = '#EEEEEE'; 
  }

  /*--
  function loadVideo() {
    pauseVideo(monitorVideo);
    pauseVideo(localVideo);
    
    localVideo.src = videoURL.value;
    localVideo.play();
    localVideo.loop = true;
    localVideo.onloadedmetadata = function() {
      console.log('localVide metadeta width=' + localVideo.videoWidth + ' , height=' + localVideo.videoHeight);
      duplicateCanvas.width = localVideo.videoWidth;
      duplicateCanvas.height = localVideo.videoHeight;
      if (ctxDuplicate) {
        ctxDuplicate = null;
      }
      ctxDuplicate = duplicateCanvas.getContext('2d');
      playVideo(monitorVideo, duplicateStream); // Only from same origin
    }
    animationId = window.requestAnimationFrame(drawCanvas);
  }
  --*/

  // start local video
  function startVideo() {
    pauseVideo(monitorVideo);
    pauseVideo(localVideo);

    if (! videoFileToPlay) {
      console.warn('file not selected');
      return;
    }

    playVideo(localVideo, videoFileToPlay);
    localVideo.loop = true;
    localVideo.onloadedmetadata = function() {
      console.log('localVide metadeta width=' + localVideo.videoWidth + ' , height=' + localVideo.videoHeight);
      duplicateCanvas.width = localVideo.videoWidth;
      duplicateCanvas.height = localVideo.videoHeight;
      if (ctxDuplicate) {
        ctxDuplicate = null;
      }
      ctxDuplicate = duplicateCanvas.getContext('2d');
      playVideo(monitorVideo, duplicateStream);
    }
    animationId = window.requestAnimationFrame(drawCanvas);
  }

  // stop local video
  function stopVideo() {
    pauseVideo(localVideo);
 
    if (animationId) {
      window.cancelAnimationFrame(animationId);
      animationId = null;
    }
  }


  // ---------------------- audio handling ----------------------- 
  function setSelectedAudioFile() {
    if (selectedAudioFile.files.length == 0) {
      console.warn('file not selected');
      return;
    }

    audioFileToPlay = selectedAudioFile.files[0];
    console.log('selected file=' + audioFileToPlay.name);
    startAudio();
  }

  // start local video
  function startAudio() {
    pauseAudio(localAudio);

    if (! audioFileToPlay) {
      console.warn('file not selected');
      return;
    }

    playAudio(localAudio, audioFileToPlay);
    localAudio.loop = true;
    localAudio.onloadedmetadata = function() {
      console.log('onloadedmetadata');
    }

    loadLocalAudio(audioFileToPlay);
  }

  // stop local video
  function stopAudio() {
    pauseAudio(localAudio);
    stopAudioContext();
  }
  
  function loadLocalAudio(file) {    
    let reader = new FileReader;
    reader.readAsArrayBuffer(file);
    reader.onload = function(evt) {
      console.log('reader.onload(), evt:', evt);
      audioContext.decodeAudioData(reader.result, function(buffer) {
        //playAudioContext(buffer);
      });
    }
    reader.onloadend = function(evt) {
      console.log('reader.onloadend(), evt:', evt);
    }
    reader.onloadstart = function(evt) {
      console.log('reader.onloadstart(), evt:', evt);
    }
  }


  // --------------------------------------
  function stopLocalStream(stream) {
    if (!stream) {
      return;
    }
    let tracks = stream.getTracks();
    if (! tracks) {
      console.warn('NO tracks');
      return;
    }
    
    for (let track of tracks) {
      track.stop();
    }
  }

  function drawCanvas() {
    ctxDuplicate.drawImage(localVideo, 0, 0, localVideo.videoWidth, localVideo.videoHeight,
      0, 0, duplicateCanvas.width , duplicateCanvas.height
    );

    // animation frame will be drop down, when window is hidden.
    animationId = window.requestAnimationFrame(drawCanvas);
  }

  function playVideo(element, stream) {
    //if ('srcObject' in element) {
    //  element.srcObject = stream;
    //}
    //else {
      element.src = window.URL.createObjectURL(stream);
    //}
    element.play();
    element.volume = 0;
  }

  function pauseVideo(element) {
    element.pause();
    if ('srcObject' in element) {
      element.srcObject = null;
    }
    else {
      if (element.src && (element.src !== '') ) {
        window.URL.revokeObjectURL(element.src);
      }
      element.src = '';
    }
  }

  function playAudio(element, stream) {
    element.src = window.URL.createObjectURL(stream);
    element.play();
    element.volume = 0;
  }

  function pauseAudio(element) {
    if (element.src && (element.src !== '') ) {
      window.URL.revokeObjectURL(element.src);
    }
    element.src = '';
  }

</script>
</html>
